
// find all cve details in the web content, and do the proper modifications
window.addEventListener('load', (event) => {
  let port = chrome.runtime.connect({name: "cve_details_msgport"});
  find_all_cve_ids(document.documentElement.innerHTML)
});

// Query cve details from the extension using runtime messages.
function query_CVE_details(cve_id, callback){
  chrome.runtime.sendMessage({type: "cve_details", options: { message: cve_id} }, 
  (response)=>{
    callback(response)
  })
}

//find all the cve id's in the content, iterate over each
function find_all_cve_ids(body){
  match = body.match(/CVE-[0-9]{4}-[0-9]{3,6}/ig) //5 characters at the end max? 6?
  if(!match) return;

  //make unique list
  match = [...new Set(match)]

  for(var i =0;i<match.length;i++){
    //normalize format
    let m = match[i].toUpperCase()

    //Query details
    query_CVE_details(m, (response)=>{
      //hyperlink the cve id to the nvd website, also add the correct class for hover controls
      cve_regex = new RegExp(m, "g")
      marker_regex = new RegExp("{{cve-details-ext-cve-id-marker}}", "g")
      
      //Iterate all nodes and filter only text nodes
      $("*").contents().filter(function() {
          return this.nodeType == 3
      }).each(function(){
          //replace all cve id's in the text nodes with a unique marker
          this.textContent = this.textContent.replace(cve_regex, "{{cve-details-ext-cve-id-marker}}");
      });

      //Now replace all the occurrences of marker in the document
      document.body.innerHTML = document.body.innerHTML.replace(marker_regex, `<a class="cve-details-ext-hover-trigger-${m}" href="https://nvd.nist.gov/vuln/detail/${m  }">${m}</a>`)
      create_cve_detail_div(response[m])
    })
    
  }
}

//Create and add the functionality to the hovering box for the cve struct
function create_cve_detail_div(cve){
  let div = `
  <div class="cve-details-ext-hovering"  id="cve-details-ext-${cve.id}">
    <h2 class="cve-details-ext-cve-id">${cve.id}</h2><br>
    <div class="cve-details-ext-publish-date"> Published: ${cve.Published} </div>
    <p>${cve.summary}</p>
  </div>
  `
  document.body.innerHTML +=div

  //hover around mouse
  $(`.cve-details-ext-hover-trigger-${cve.id}`).bind('mousemove', function(e){
      $(`#cve-details-ext-${cve.id}`).show();
      $(`#cve-details-ext-${cve.id}`).css({
        left:  e.pageX + 20,
        top:   e.pageY
      });
      $(`.cve-details-ext-hover-trigger-${cve.id}`).bind('mouseleave', function(e){
      $(`#cve-details-ext-${cve.id}`).hide();
    });
  });
}
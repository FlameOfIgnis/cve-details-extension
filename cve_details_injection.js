window.addEventListener('load', (event) => {
  let port = chrome.runtime.connect({name: "cve_details_msgport"});
  find_all_cve_ids(document.documentElement.innerHTML)
});


function query_CVE_details(cve_id, callback){
  chrome.runtime.sendMessage({type: "cve_details", options: { message: cve_id} }, 
  (response)=>{
    callback(response)
  })
}

function find_all_cve_ids(body){
  match = body.match(/CVE-[0-9]{4}-[0-9]{3,6}/ig)
  if(!match) return;
  match = [...new Set(match)]
  for(var i =0;i<match.length;i++){
    let m = match[i].toUpperCase()
    query_CVE_details(m, (response)=>{
      console.log(response)

      document.body.innerHTML = document.body.innerHTML.replace(m, `<a class="cve-details-ext-hover-trigger-${m}" href="https://nvd.nist.gov/vuln/detail/${m  }">${m}</a>`)
      create_cve_detail_div(response)
    })
    
  }
}


function create_cve_detail_div(cve){
  let div = `
  <div class="cve-details-ext-hovering"  id="cve-details-ext-${cve.id}">
    <h2 class="cve-details-ext-cve-id">${cve.id}</h2><br>
    <div class="cve-details-ext-publish-date"> Published: ${cve.Published} </div>
    <p>${cve.summary}</p>
  </div>
  `

  document.body.innerHTML +=div

  $(`.cve-details-ext-hover-trigger-${cve.id}`).bind('mousemove', function(e){
      $(`#cve-details-ext-${cve.id}`).show();
      $(`#cve-details-ext-${cve.id}`).css({
        left:  e.pageX + 20,
        top:   e.pageY
      });
      $(`.cve-details-ext-hover-trigger-${cve.id}`).bind('mouseleave', function(e){
      $(`#cve-details-ext-${cve.id}`).hide();
    });
  });
}